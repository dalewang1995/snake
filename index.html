<!--
 * @Author: æ±ªå°é±¼
 * @Date: 2022-12-20 15:05:04
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ªåƒè›‡</title>
</head>
<style type="text/css">
    canvas { border: 2px solid #ddd; }
    .top-panel {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
  </style>
<body>
    <div class="top-panel">
        <div>å¾—åˆ†ï¼š<span class="score">0</span></div>
        <div>
            <button class="start" onclick="startGame()">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
    <canvas id="snake" width="594" height="528"></canvas>
</body>
<script type="text/javascript">


// 1. éšæœºåœ¨ç©ºç™½åæ ‡ç‚¹ç”Ÿæˆé£Ÿç‰©
// 2. è›‡ä¸èƒ½æ’å¢™ ç¢°åˆ°è‡ªå·±
// 3. æ¯åƒä¸€ä¸ªé£Ÿç‰©èº«ä½“é•¿ä¸€æ ¼
// 4. è›‡æœ‰å›ºå®šçš„åˆå§‹é€Ÿåº¦
// 5. æ–¹å‘çš„æ”¹å˜ç”¨é”®ç›˜çš„æ–¹å‘é”®æ§åˆ¶ï¼Œä¸èƒ½ç›´æ¥å¾€åæ–¹å‘è½¬å‘

    const canvas = document.getElementById('snake');
    const ctx = canvas.getContext('2d');

    const canvasHeight = 594
    const canvasWidth = 528

    // ç½‘æ ¼ èƒŒæ™¯ ç»˜åˆ¶
    const maxY = 16
    const maxX = 18
    const itemWidth = 33

    // é£Ÿç‰©é—ªçƒ
    let flashing = 1

    // ğŸæ•°æ®çš„åˆå§‹åŒ–
    let snake = [
        [6, 12],
        [5, 12],
        [4, 12],
        [3, 12],
        [2, 12]
    ]

    // è›‡é€Ÿåº¦æ§åˆ¶
    const snakeSpeed = 260

    // åˆå§‹åˆ†æ•°
    let initscore = 0

    // è¡¨æ ¼åæ ‡è®¡ç®—
    const grid = []

    for (let i = 0; i < maxX; i++) {
        for (let j = 0; j < maxY; j++) {
          grid.push([i, j])
        } 
    }

    // ç”Ÿæˆé£Ÿç‰©éšæœºåæ ‡ç‚¹
    let food = []

    // ç”Ÿæˆéšæœºåæ ‡ç‚¹
    const createPos = function() {
        // å–æ•´è·å–éšæœºåæ ‡ç‚¹
        let [x, y] = grid[(Math.random() * grid.length) | 0]

        // åæ ‡ç‚¹ä¸èƒ½æ˜¯è›‡å†…çš„åæ ‡
        if (snake.some(v => v[0] === x && v[1] === y)) {
            return this.createPos()
        }

        return [x, y]
    }

    // ç”Ÿæˆé£Ÿç‰©
    makeFood = function() {
      food = createPos()
    }

    makeFood()

    const addScore = function(){
        const scoreDom = document.querySelector('.score')
        initscore++
        scoreDom.innerHTML = initscore
    }

    const grawGrid = function() {
        // ç»˜åˆ¶ ç½‘æ ¼ æ¨ªçº¿
        for (let i = 1; i < maxY; i++) {
            ctx.moveTo(0, i * itemWidth)
            ctx.lineTo(canvasHeight, i * itemWidth)
        }
        
        // ç»˜åˆ¶ ç½‘æ ¼ ç«–çº¿
        for (let i = 1; i < maxX; i++) {
            ctx.moveTo(i * itemWidth, 0)
            ctx.lineTo(i * itemWidth, canvasWidth)
        }
        ctx.lineWidth = 1
        ctx.strokeStyle = '#ddd'
        ctx.stroke()
    }
    grawGrid()

    // ç»˜åˆ¶å‡½æ•°
    const draw = function() {
        ctx.clearRect(0, 0, canvasHeight, canvasWidth)

        grawGrid()

        // ç»˜åˆ¶é£Ÿç‰©
        ctx.fillStyle="#FFB433"
        ctx.fillRect(
            food[0] * itemWidth + flashing,
            food[1] * itemWidth + flashing,
            itemWidth - flashing * 2,
            itemWidth - flashing * 2 
        )

        // XORå¼‚æˆ–è¿ç®— åŒå€¼å–0 å¼‚å€¼å–1
        flashing ^= 1

        // ç»˜åˆ¶è›‡å¤´
        ctx.fillStyle="#FF5733"
        ctx.fillRect(
            snake[0][0] * itemWidth + 0.5,
            snake[0][1] * itemWidth + 0.5,
            itemWidth - 1,
            itemWidth - 1
        )

        // ç»˜åˆ¶è›‡èº«
        ctx.fillStyle="#E4FF33"
        for (let i = 1; i < snake.length; i++) {
            ctx.fillRect(
                snake[i][0] * itemWidth + 0.5,
                snake[i][1] * itemWidth + 0.5,
                itemWidth - 1,
                itemWidth - 1
            )
        }
    }

    // è›‡çš„åˆå§‹è¿åŠ¨æ–¹å‘
    let direction = 'right';

    // è›‡çš„æ¡ˆä»¶æ§åˆ¶
    const snakeControlListener = function() {
        document.onkeydown = function(e) {
            switch(e.keyCode) {
            case 37:
                if (direction !== 'right') {
                    direction = 'left'
                }
                break
            case 38:
                if (direction !== 'down') {
                    direction = 'up'
                }
                break
            case 39:
                if (direction !== 'left') {
                    direction = 'right'
                }
                break
            case 40:
                if (this.direction !== 'up') {
                    direction = 'down'
                }
                break
            }
        }
    }

    // åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ
    over = function([x, y]) {
      if (x < 0 || x >= maxX || y < 0 || y >= maxY) {
        return true
      }
      
      if (snake.some(v => v[0] === x && v[1] === y)) {
        return true
      }
    }

    // è›‡çš„ç§»åŠ¨
    const snakeMove = function(){
        
    }
    // è›‡çš„è‡ªåŠ¨è¿åŠ¨
    const snakeAutoMove = function(){
        let [x, y] = snake[0]
        switch(direction) {
            case 'left':
                x--
                break
            case 'right':
                x++
                break
            case 'up':
                y--
                break
            case 'down':
                y++
                break
        }

        // æ˜¯å¦åƒåˆ°é£Ÿç‰©
        if(x === food[0] && y === food[1]){
            makeFood()
            addScore()
        } else {
            snake.pop()
        }
        // ç»“æŸåˆ¤æ–­
        if(over([x, y])){
            clearInterval(timer)
            return 
        }
        snake.unshift([x, y])
    }

    // åˆå§‹åŒ–
    snakeControlListener()

    // è›‡çš„çˆ¬è¡Œ
    let timer = null

    const startGame = function() {
        if(timer) {
            clearInterval(timer)
        }

        // å˜é‡æ¸…ç©º
        snake = [
            [6, 12],
            [5, 12],
            [4, 12],
            [3, 12],
            [2, 12]
        ]
        initscore = 0

        timer = setInterval(()=>{
            draw()
            snakeAutoMove()
        }, snakeSpeed)
    }
    
</script>
</html>
